#
# OpenTHC Full Docker Environment
#
# SPDX-License-Identifier: GPL-3.0-only
#

name: openthc

services:

  # @see https://dev.to/kittipat1413/deploying-your-container-with-https-using-traefik-as-a-reverse-proxy-1859
  # @see https://www.youtube.com/watch?v=naCHq6sMMI8
  traefik:
    container_name: hub.openthc.me
    image: "traefik:v2.11.0"
    labels:
      - "traefik.http.routers.api.rule=Host(`hub.openthc.me`)"
      - "traefik.http.routers.api.service=api@internal"
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
    restart: unless-stopped
    ports:
      - "80:80"
      # - "443:443"
    volumes:
      # - ../etc/traefik/traefik.yaml:/etc/traefik/traefik.yml
      # - ../etc/traefik/tls.yaml:/etc/traefik/tls.yml
      # - ../etc/traefik/ssl:/etc/ssl/traefik
      - /var/run/docker.sock:/var/run/docker.sock


  # The SQL Database Service
  sql:
    container_name: sql.openthc.me
    image: openthc/sql
    environment:
      - POSTGRES_PASSWORD="passweed"
    # volumes:
    #   - ./volumes/sql/data:/var/lib/postgres/data


  # The Redis System
  # @see https://github.com/nextcloud/all-in-one/discussions/1731
  rdb:
    container_name: rdb.openthc.me
    image: redis


  # Single Sign On Services
  sso:
    container_name: sso.openthc.me
    image: openthc/sso
    labels:
      - "traefik.http.routers.sso.rule=Host(`sso.openthc.me`)"
      # - "traefik.http.routers.sso-tls.tls.domains[0].main=sso.openthc.me"
    depends_on:
      - traefik
      - sql
      - rdb
    env_file:
      - path: ".env"
        required: false
    volumes:
      - type: bind
        source: ./etc/sso/config.php
        target: /opt/openthc/sso/etc/config.php
        read_only: true
    networks:
      default:
        aliases:
          - sso.openthc.me
    expose:
      - "80"


  # Compliance Reporting Engine
  cre:
    container_name: cre.openthc.me
    image: openthc/cre
    labels:
      - "traefik.http.routers.cre.rule=Host(`cre.openthc.me`)"
    depends_on:
      - traefik
      - sql
      - rdb
    env_file:
      - path: ".env"
        required: false
    volumes:
      - type: bind
        source: ./etc/cre/config.php
        target: /opt/openthc/cre/etc/config.php
        read_only: true
      # - openthc-gfs
    networks:
      default:
        aliases:
          - cre.openthc.me
    expose:
      - "80"


  # PIPE
  # pipe:
  #   container_name: pipe.openthc.me
  #   image: openthc/pipe
  #   labels:
  #     - "traefik.http.routers.pipe.rule=Host(`pipe.openthc.me`)"
  #   depends_on:
  #     - traefik
  #     - sql
  #     - rdb
  #   env_file:
  #     - path: ".env"
  #       required: false
  #   volumes:
  #     - type: bind
  #       source: ./etc/pipe/config.php
  #       target: /opt/openthc/pipe/etc/config.php
  #       read_only: true
  #   networks:
  #     default:
  #       aliases:
  #         - pipe.openthc.me
  #   expose:
  #     - "80"


  # BONG
  # bong:
  #   container_name: bong.openthc.me
  #   image: openthc/bong
  #   labels:
  #     - "traefik.http.routers.bong.rule=Host(`bong.openthc.me`)"
  #   depends_on:
  #     - traefik
  #     - sql
  #     - rdb
  #   env_file:
  #     - path: ".env"
  #     required: false
  #   volumes:
  #     - type: bind
  #       source: ./etc/bong/config.php
  #       target: /opt/openthc/bong/etc/config.php
  #       read_only: true
  #   networks:
  #     default:
  #       aliases:
  #         - bong.openthc.me
  #   expose:
  #     - "80"


  # Main Application / S2S / TNT
  app:
    container_name: app.openthc.me
    image: openthc/app
    labels:
      - "traefik.http.routers.app.rule=Host(`app.openthc.me`)"
    depends_on:
      - traefik
      - sql
      - rdb
    env_file:
      - path: ".env"
        required: false
    volumes:
      - type: bind
        source: ./etc/app/config.php
        target: /opt/openthc/app/etc/config.php
        read_only: true
    networks:
      default:
        aliases:
          - app.openthc.me
    expose:
      - "80"


  # Point of Sale
  pos:
    container_name: pos.openthc.me
    image: openthc/pos
    labels:
      - "traefik.http.routers.pos.rule=Host(`pos.openthc.me`)"
    depends_on:
      - traefik
      - sql
      - rdb
    env_file:
      - path: ".env"
        required: false
    volumes:
      - type: bind
        source: ./etc/pos/config.php
        target: /opt/openthc/pos/etc/config.php
        read_only: true
    networks:
      default:
        aliases:
          - pos.openthc.me
    expose:
      - "80"


volumes:
  gfs:
    name: gfs.openthc.me
